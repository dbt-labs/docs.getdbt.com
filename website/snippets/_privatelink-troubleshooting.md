## Troubleshooting

If the PrivateLink endpoint has been provisioned and configured in dbt Cloud, but connectivity is still failing, check the following in your networking setup to ensure requests and responses can be successfully routed between dbt Cloud and the backing service.

### Configuration

1. **NLB Security Group** - The Network Load Balancer (NLB) associated with the VPC Endpoint Service must either not have an associated Security Group, or the Security Group must have a rule that allows requests from the appropriate dbt Cloud _private CIDR(s)_. Note that this is different than the static public IPs listed on the dbt Cloud Connection page. The correct private CIDR(s) can be provided by dbt Support upon request.
    - NOTE: To test if this is the issue, temporarily adding an allow rule of `10.0.0.0/8` should allow connectivity until the rule can be refined to a smaller CIDR
2. **NLB Listener and Target Group** - Check that there is a Listener connected to the NLB that matches the port that dbt Cloud is trying to connect to. This Listener must have a configured action to forward to a Target Group with targets that point to your backing service. At least one (but preferrably all) of these targets must be **Healthy**. Unhealthy targets could suggest that the backing service is in fact unhealthy, or that the service is protected by a Security Group that doesn't allow requests from the NLB.
3. **Cross-zone Load Balancing** - Check that _Cross-zone load balancing_ is enabled for your NLB (check the **Attributes** tab of the NLB in the AWS console). If this is disabled, and the zones that dbt Cloud is connected to are misaligned with the zones where the service is running, requests may not be able to be routed correctly. Enabling cross-zone load balancing will also make the connection more resilient in the case of a failover in a zone outage scenario. Note that cross-zone connectivity may incur additional data transfer charges, though this should be minimal for requests from dbt Cloud. 
4. **Routing tables and ACLs** - If all the above check out, it may be possible that requests are not routing correctly within the private network. This could be due to a misconfiguration in the VPCs routing tables or access control lists. Review these settings with your network administrator to ensure that requests can be routed from the VPC Endpoint Service to the backing service, and that the response can return to the VPC Endpoint Service. One way to test this is to create a VPC endpoint in another VPC in your own network to test that connectivity is working independent of dbt's connection. 

### Monitoring

To help isolate connection issues over a PrivateLink connection from dbt Cloud there are a few monitoring sources that can be used to verify request activity. To see anything in the monitoring there will first have to be requests sent to the endpoint. Contact dbt Support to understand when connection testing occurred or request new connection attempts. Use these times to correlate with activity in the following monitoring sources.

- **VPC Endpoint Service Monitoring** - In the AWS Console, navigate to VPC -> Endpoint Services. Select the Endpoint Service being tested and click the **Monitoring** tab. Update the time selection to include the times when test connection attempts were sent. If there is activity in the _New connections_ and _Bytes processed_ graphs then requests have been received by the Endpoint Service, suggesting that the dbt endpoint is routing properly.
- **NLB Monitoring** - In the AWS Console, navigate to EC2 -> Load Balancers. Select the Network Load Balancer (NLB) being tested and click the **Monitoring** tab. Update the time selection to include the times when test connection attempts were sent. If there is activity in the _New flow count_ and _Processed bytes_ graphs then requests have been received by the NLB from the Endpoint Service, suggesting the NLB Listener, Target Group, and Security Group are correctly configured.
- **VPC Flow Logs** - VPC Flow Logs can provide a variety of useful information for requests that are being routed through your VPCs, though they can sometimes be difficult to locate and interpret. Flow logs can be written to either S3 or CloudWatch Logs, so determine the availability of these logs for your VPC and query them accordingly. Flow logs record the Elastic Network Interface (ENI) ID, source and destination IP and port, and whether the request was accepted or rejected by the security group and/or network ACL. This can be useful in understanding if a request arrived at a certain network interface and whether that request was accepted, potentially illuminating overly restrictive rules. For more on accessing and interpreting VPC Flow Logs see the related [AWS documentation](https://docs.aws.amazon.com/vpc/latest/userguide/flow-logs.html).